---
title: 'Auth0é›†æˆï¼šCypressæŒ‡å—'
sidebar_label: 'Auth0è®¤è¯'
description: 'ä½¿ç”¨Cypressæ— ç¼å®ç°Auth0è®¤è¯ã€‚é›†æˆAuth0è®¤è¯è¿›è¡Œå®‰å…¨æµ‹è¯•'
---

<ProductHeading product="app" />

# Auth0è®¤è¯

:::info

##### <Icon name="question-circle" color="#4BBFD2" /> ä½ å°†å­¦ä¹ åˆ°

- å¦‚ä½•åœ¨Cypressæµ‹è¯•ä¸­ä½¿ç”¨Auth0è¿›è¡Œè®¤è¯
- å¦‚ä½•ä¸ºæµ‹è¯•é€‚é…Auth0åº”ç”¨
- Auth0é€Ÿç‡é™åˆ¶çš„æ³¨æ„äº‹é¡¹

:::

æœ¬æŒ‡å—é’ˆå¯¹ä½¿ç”¨[ç»å…¸é€šç”¨ç™»å½•ä½“éªŒ](https://auth0.com/docs/universal-login/classic)çš„[Auth0](https://auth0.com)å•é¡µåº”ç”¨æµ‹è¯•è¿›è¡Œè®¾ç½®ã€‚æ­¤é…ç½®æ¨èç”¨äºè‡ªåŠ¨åŒ–ç«¯åˆ°ç«¯æµ‹è¯•çš„"æµ‹è¯•ç§Ÿæˆ·"å’Œ/æˆ–"æµ‹è¯•API"è®¾ç½®ã€‚

## Auth0åº”ç”¨è®¾ç½®

è¦å¼€å§‹ä½¿ç”¨Auth0ï¼Œéœ€è¦é€šè¿‡ä»¥ä¸‹æ­¥éª¤åœ¨[Auth0ä»ªè¡¨æ¿](https://auth0.com/docs/get-started/auth0-overview/dashboard)ä¸­è®¾ç½®åº”ç”¨ï¼š

1. è®¿é—®[Auth0ä»ªè¡¨æ¿](https://auth0.com/docs/get-started/auth0-overview/dashboard)å¹¶ç‚¹å‡»"åˆ›å»ºåº”ç”¨"æŒ‰é’®ã€‚
2. è¾“å…¥åº”ç”¨çš„åç§°ã€‚
3. é€‰æ‹©"å•é¡µåº”ç”¨"

åº”ç”¨åˆ›å»ºåï¼Œè®¿é—®åº”ç”¨ä¸‹çš„[åº”ç”¨è®¾ç½®](https://auth0.com/docs/dashboard/reference/settings-application)æ ‡ç­¾é¡µï¼Œå¹¶åœ¨ä»¥ä¸‹éƒ¨åˆ†æ·»åŠ æœ¬åœ°å¼€å‘URLå’Œç«¯å£ï¼ˆä¾‹å¦‚`http://localhost:3000`ï¼‰ï¼š

- å…è®¸çš„å›è°ƒURL
- å…è®¸çš„ç™»å‡ºURL
- å…è®¸çš„Webæ¥æº
- å…è®¸çš„æ¥æº(CORS)

åœ¨[åº”ç”¨è®¾ç½®](https://auth0.com/docs/dashboard/reference/settings-application)åº•éƒ¨ï¼Œç‚¹å‡»[æ˜¾ç¤ºé«˜çº§è®¾ç½®](https://auth0.com/docs/dashboard/reference/settings-application#advanced-settings)ï¼Œé€‰æ‹©"æˆæƒç±»å‹"æ ‡ç­¾é¡µå¹¶å‹¾é€‰"å¯†ç "ï¼ˆé»˜è®¤æœªå‹¾é€‰ï¼‰ã€‚

æ¥ä¸‹æ¥ï¼Œç‚¹å‡»ç§Ÿæˆ·å›¾æ ‡ï¼ˆå³ä¸Šè§’å¤´åƒèœå•ï¼‰è¿›å…¥[ç§Ÿæˆ·è®¾ç½®](https://auth0.com/docs/get-started/tenant-settings)ã€‚åœ¨[å¸¸è§„](https://auth0.com/docs/dashboard/reference/settings-tenant#general)æ ‡ç­¾é¡µä¸­ï¼Œå‰å¾€[APIæˆæƒè®¾ç½®](https://auth0.com/docs/dashboard/reference/settings-tenant#api-authorization-settings)

- å°†"é»˜è®¤å—ä¼—"è®¾ç½®ä¸ºæµ‹è¯•åº”ç”¨çš„å—ä¼—URLï¼ˆä¾‹å¦‚`https://your-api-id.auth0.com/api/v2/`ï¼‰
- å°†"é»˜è®¤ç›®å½•"è®¾ç½®ä¸º**"ç”¨æˆ·å-å¯†ç è®¤è¯"**

:::info

å‚è€ƒ[Auth0ç§Ÿæˆ·è®¾ç½®æ–‡æ¡£](https://auth0.com/docs/dashboard/reference/settings-tenant)è·å–æ›´å¤šè¯¦æƒ…ã€‚

:::

æœ€åï¼Œåœ¨[Auth0ç”¨æˆ·å­˜å‚¨](https://auth0.com/docs/connections/database#using-the-auth0-user-store)ä¸­ä¸ºCypressæµ‹è¯•åˆ›å»ºä¸€ä¸ªç”¨æˆ·ã€‚è¿™ä¸ªä¸“ç”¨äºæµ‹è¯•çš„ç›®æ ‡ç”¨æˆ·å°†åœ¨æµ‹è¯•è§„èŒƒä¸­ç™»å½•ä½ çš„åº”ç”¨ã€‚å¦‚æœæµ‹è¯•éœ€è¦ï¼Œä½ å¯ä»¥åˆ›å»ºå¤šä¸ªç”¨æˆ·æ¥æµ‹è¯•ç‰¹å®šåº”ç”¨ã€‚

## åœ¨Cypressä¸­è®¾ç½®Auth0åº”ç”¨å‡­è¯

ä¸ºäº†åœ¨æµ‹è¯•ä¸­è®¿é—®æµ‹è¯•ç”¨æˆ·å‡­è¯ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®Cypressä½¿ç”¨`.env`æ–‡ä»¶ä¸­è®¾ç½®çš„[Auth0](https://auth0.com)ç¯å¢ƒå˜é‡ã€‚

:::cypress-config-example

```js
// ä».envæ–‡ä»¶å¡«å……process.env
require('dotenv').config()
```

```js
{
  env: {
    auth0_username: process.env.AUTH0_USERNAME,
    auth0_password: process.env.AUTH0_PASSWORD,
    auth0_domain: process.env.REACT_APP_AUTH0_DOMAIN,
    auth0_audience: process.env.REACT_APP_AUTH0_AUDIENCE,
    auth0_scope: process.env.REACT_APP_AUTH0_SCOPE,
    auth0_client_id: process.env.REACT_APP_AUTH0_CLIENTID,
    auth0_client_secret: process.env.AUTH0_CLIENT_SECRET,
  },
}
```

:::

æ³¨æ„`auth0_client_secret`ä»…ç”¨äº[ç¼–ç¨‹å¼ç™»å½•](#Programmatic-Login)ã€‚

## Auth0è®¤è¯çš„è‡ªå®šä¹‰å‘½ä»¤

æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è®¤è¯åˆ°Auth0ï¼š

- [ä½¿ç”¨`cy.origin()`ç™»å½•](#Login-with-cyorigin)
- [ç¼–ç¨‹å¼ç™»å½•](#Programmatic-Login)

### ä½¿ç”¨[`cy.origin()`](/api/commands/origin)ç™»å½•

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªåä¸º`loginToAuth0`çš„è‡ªå®šä¹‰å‘½ä»¤æ¥æ‰§è¡Œ[Auth0](https://auth0.com)ç™»å½•ã€‚è¯¥å‘½ä»¤å°†ä½¿ç”¨[`cy.origin()`](/api/commands/origin)æ¥ï¼š

1. å¯¼èˆªåˆ°Auth0ç™»å½•é¡µ
2. è¾“å…¥ç”¨æˆ·å‡­è¯
3. ç™»å½•å¹¶é‡å®šå‘å›[Cypress Real World App](https://github.com/cypress-io/cypress-realworld-app)
4. ä½¿ç”¨[`cy.session()`](/api/commands/session)ç¼“å­˜ç»“æœ

```js title="cypress/support/auth-provider-commands/auth0.ts"
function loginViaAuth0Ui(username: string, password: string) {
  // åº”ç”¨ç™»å½•é¡µé‡å®šå‘åˆ°Auth0
  cy.visit('/')

  // åœ¨Auth0ä¸Šç™»å½•
  cy.origin(
    Cypress.env('auth0_domain'),
    { args: { username, password } },
    ({ username, password }) => {
      cy.get('input#username').type(username)
      cy.get('input#password').type(password, { log: false })
      cy.contains('button[value=default]', 'Continue').click()
    }
  )

  // ç¡®ä¿Auth0å·²å°†æˆ‘ä»¬é‡å®šå‘å›RWA
  cy.url().should('equal', 'http://localhost:3000/')
}

Cypress.Commands.add('loginToAuth0', (username: string, password: string) => {
  const log = Cypress.log({
    displayName: 'AUTH0 LOGIN',
    message: [`ğŸ” è®¤è¯ä¸­ | ${username}`],
    // @ts-ignore
    autoEnd: false,
  })
  log.snapshot('before')

  loginViaAuth0Ui(username, password)

  log.snapshot('after')
  log.end()
})
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä¸­ä½¿ç”¨`loginToAuth0`å‘½ä»¤ã€‚ä»¥ä¸‹æ˜¯é€šè¿‡Auth0ç™»å½•ç”¨æˆ·å¹¶è¿è¡ŒåŸºæœ¬å¥å…¨æ€§æ£€æŸ¥çš„æµ‹è¯•ã€‚

:::info

æ­¤æµ‹è¯•çš„[å¯è¿è¡Œç‰ˆæœ¬](https://github.com/cypress-io/cypress-realworld-app/blob/develop/cypress/tests/ui-auth-providers/auth0.spec.ts)åœ¨<Icon name="github" inline="true" contentType="rwa" />ä¸­ã€‚

:::

```js title='auth.cy.js'
describe('Auth0', function () {
  beforeEach(function () {
    cy.task('db:seed')
    cy.intercept('POST', '/graphql').as('createBankAccount')
    cy.loginToAuth0(
      Cypress.env('auth0_username'),
      Cypress.env('auth0_password')
    )
    cy.visit('/')
  })

  it('æ˜¾ç¤ºå¼•å¯¼é¡µé¢', function () {
    cy.contains('Get Started').should('be.visible')
  })
})
```

<DocsVideo
  src="https://vimeo.com/789093942"
  title="ä½¿ç”¨cy.origin()è¿›è¡ŒAuth0è®¤è¯"
/>

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é‡æ„ç™»å½•å‘½ä»¤ä»¥åˆ©ç”¨[`cy.session()`](/api/commands/session)å­˜å‚¨å·²ç™»å½•ç”¨æˆ·ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…åœ¨æ¯æ¬¡æµ‹è¯•å‰é‡æ–°è®¤è¯ã€‚

```js title="cypress/support/commands.js"
Cypress.Commands.add('loginToAuth0', (username: string, password: string) => {
  const log = Cypress.log({
    displayName: 'AUTH0 LOGIN',
    message: [`ğŸ” è®¤è¯ä¸­ | ${username}`],
    // @ts-ignore
    autoEnd: false,
  })
  log.snapshot('before')

  cy.session(
    `auth0-${username}`,
    () => {
      loginViaAuth0Ui(username, password)
    },
    {
      validate: () => {
        // éªŒè¯localStorageä¸­æ˜¯å¦å­˜åœ¨è®¿é—®ä»¤ç‰Œ
        cy.wrap(localStorage)
          .invoke('getItem', 'authAccessToken')
          .should('exist')
      },
    }
  )

  log.snapshot('after')
  log.end()
})
```

<DocsVideo
  src="https://vimeo.com/789093910"
  title="ä½¿ç”¨cy.session()è¿›è¡ŒAuth0è®¤è¯"
/>

### ç¼–ç¨‹å¼ç™»å½•

ä»¥ä¸‹æ˜¯ä½¿ç”¨[/oauth/tokenç«¯ç‚¹](https://auth0.com/docs/protocols/protocol-oauth2#token-endpoint)ç¼–ç¨‹å¼ç™»å½•[Auth0](https://auth0.com)çš„å‘½ä»¤ï¼Œå¹¶åœ¨`localStorage`ä¸­è®¾ç½®ä¸€ä¸ªåŒ…å«è®¤è¯ç”¨æˆ·è¯¦æƒ…çš„é¡¹ï¼Œæˆ‘ä»¬å°†åœ¨åº”ç”¨ä»£ç ä¸­ä½¿ç”¨å®ƒæ¥éªŒè¯æµ‹è¯•ä¸­çš„è®¤è¯çŠ¶æ€ã€‚

`loginByAuth0Api`å‘½ä»¤å°†æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. ä½¿ç”¨[/oauth/tokenç«¯ç‚¹](https://auth0.com/docs/protocols/protocol-oauth2#token-endpoint)æ‰§è¡Œç¼–ç¨‹å¼ç™»å½•ã€‚
2. æœ€åå°†`access token`ã€`id_token`å’Œç”¨æˆ·é…ç½®æ–‡ä»¶è®¾ç½®ä¸º`localStorage`ä¸­çš„`auth0Cypress`é¡¹ã€‚

```jsx title="cypress/support/commands.js"
Cypress.Commands.add(
  'loginByAuth0Api',
  (username: string, password: string) => {
    cy.log(`ä»¥${username}èº«ä»½ç™»å½•`)
    const client_id = Cypress.env('auth0_client_id')
    const client_secret = Cypress.env('auth0_client_secret')
    const audience = Cypress.env('auth0_audience')
    const scope = Cypress.env('auth0_scope')

    cy.request({
      method: 'POST',
      url: `https://${Cypress.env('auth0_domain')}/oauth/token`,
      body: {
        grant_type: 'password',
        username,
        password,
        audience,
        scope,
        client_id,
        client_secret,
      },
    }).then(({ body }) => {
      const claims = jwt.decode(body.id_token)
      const {
        nickname,
        name,
        picture,
        updated_at,
        email,
        email_verified,
        sub,
        exp,
      } = claims

      const item = {
        body: {
          ...body,
          decodedToken: {
            claims,
            user: {
              nickname,
              name,
              picture,
              updated_at,
              email,
              email_verified,
              sub,
            },
            audience,
            client_id,
          },
        },
        expiresAt: exp,
      }

      window.localStorage.setItem('auth0Cypress', JSON.stringify(item))

      cy.visit('/')
    })
  }
)
```

é€šè¿‡æ­£ç¡®è®¾ç½®Auth0å¼€å‘è€…æ§åˆ¶å°ä¸­çš„åº”ç”¨ã€å¿…è¦çš„ç¯å¢ƒå˜é‡ä»¥åŠå®ç°`loginByAuth0Api`å‘½ä»¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æµ‹è¯•åº”ç”¨æ—¶ä½¿ç”¨Auth0è¿›è¡Œè®¤è¯ã€‚ä»¥ä¸‹æ˜¯é€šè¿‡[Auth0](https://auth0.com)ç™»å½•ç”¨æˆ·ã€å®Œæˆå¼•å¯¼æµç¨‹å¹¶ç™»å‡ºçš„æµ‹è¯•ã€‚

```jsx title="auth.cy.js"
describe('Auth0', function () {
  beforeEach(function () {
    cy.task('db:seed')
    cy.loginByAuth0Api(
      Cypress.env('auth0_username'),
      Cypress.env('auth0_password')
    )
  })

  it('æ˜¾ç¤ºå¼•å¯¼é¡µé¢', function () {
    cy.contains('Get Started').should('be.visible')
  })
})
```

## ä¸ºæµ‹è¯•é€‚é…Auth0åº”ç”¨

:::info

<strong>æ³¨æ„</strong>

å‰å‡ èŠ‚é‡ç‚¹ä»‹ç»äº†Cypressæµ‹è¯•ä¸­æ¨èçš„Auth0è®¤è¯å®è·µã€‚è¦ä½¿ç”¨æ­¤å®è·µï¼Œå‡è®¾ä½ æ­£åœ¨æµ‹è¯•ä¸€ä¸ªå·²æ­£ç¡®æ„å»ºæˆ–é€‚é…ä¸ºä½¿ç”¨Auth0çš„åº”ç”¨ã€‚

ä»¥ä¸‹éƒ¨åˆ†æä¾›äº†æ„å»ºæˆ–é€‚é…åº”ç”¨ä»¥ä½¿ç”¨Auth0è®¤è¯çš„æŒ‡å—ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä½ æ­£åœ¨[ä½¿ç”¨`cy.origin()`ç™»å½•](#Login-with-cyorigin)ä¸”ä½ çš„åº”ç”¨å·²æˆåŠŸé›†æˆAuth0ï¼Œåˆ™æ— éœ€å¯¹åº”ç”¨è¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œæœ¬æŒ‡å—çš„å…¶ä½™éƒ¨åˆ†åº”ä»…ä½œä¸ºä¿¡æ¯å‚è€ƒã€‚

:::

<Icon name="github" inline="true" contentType="rwa" />è¢«ä½¿ç”¨ï¼Œå¹¶ä¸ºReact SPAå’ŒExpressåç«¯æä¾›äº†é…ç½®å’Œå¯è¿è¡Œä»£ç ã€‚

å‰ç«¯ä½¿ç”¨[auth0-react SDK](https://github.com/auth0/auth0-react)ç”¨äºReactå•é¡µåº”ç”¨(SPA)ï¼Œå…¶åº•å±‚ä½¿ç”¨[auth0-spa-js SDK](https://github.com/auth0/auth0-spa-js)ã€‚åç«¯ä½¿ç”¨[express-jwt](https://github.com/auth0/express-jwt)æ¥éªŒè¯é’ˆå¯¹[Auth0](https://auth0.com)çš„JWTã€‚

:::info

<strong>æ³¨æ„</strong>

å¯åŠ¨[Cypress Real World App](https://github.com/cypress-io/cypress-realworld-app)æ—¶ä½¿ç”¨`yarn dev:auth0`å‘½ä»¤ã€‚

:::

### é€‚é…åç«¯

ä¸ºäº†éªŒè¯æ¥è‡ªå‰ç«¯çš„APIè¯·æ±‚ï¼Œæˆ‘ä»¬å®‰è£…[express-jwt](https://github.com/auth0/express-jwt)å’Œ[jwks-rsa](https://github.com/auth0/node-jwks-rsa)å¹¶é…ç½®éªŒè¯æ¥è‡ª[Auth0](https://auth0.com)çš„JWTã€‚

```jsx title='backend/helpers.ts'
import jwt from 'express-jwt'
import jwksRsa from 'jwks-rsa'

dotenv.config()

const auth0JwtConfig = {
  secret: jwksRsa.expressJwtSecret({
    cache: true,
    rateLimit: true,
    jwksRequestsPerMinute: 5,
    jwksUri: `https://${process.env.REACT_APP_AUTH0_DOMAIN}/.well-known/jwks.json`,
  }),

  // éªŒè¯å—ä¼—å’Œå‘è¡Œè€…
  audience: process.env.REACT_APP_AUTH0_AUDIENCE,
  issuer: `https://${process.env.REACT_APP_AUTH0_DOMAIN}/`,
  algorithms: ['RS256'],
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªExpressä¸­é—´ä»¶å‡½æ•°ï¼Œç”¨äºåœ¨æˆ‘ä»¬çš„è·¯ç”±ä¸­éªŒè¯å‰ç«¯APIè¯·æ±‚å‘é€çš„[Auth0](https://auth0.com) JWTä½œä¸º`Bearer`ä»¤ç‰Œã€‚

```jsx title='backend/helpers.ts'
// ...

export const checkJwt = jwt(auth0JwtConfig).unless({ path: ['/testData/*'] })
```

å®šä¹‰æ­¤è¾…åŠ©å‡½æ•°åï¼Œæˆ‘ä»¬å¯ä»¥å…¨å±€åº”ç”¨å®ƒåˆ°æ‰€æœ‰è·¯ç”±ï¼š

```jsx title='backend/app.ts'
// åˆå§‹å¯¼å…¥...
import { checkJwt } from './helpers'

// ...

if (process.env.REACT_APP_AUTH0) {
  app.use(checkJwt)
}

// è·¯ç”±...
```

### é€‚é…å‰ç«¯

æˆ‘ä»¬éœ€è¦æ›´æ–°å‰ç«¯Reactåº”ç”¨ä»¥å…è®¸ä½¿ç”¨[Auth0](https://auth0.com)è¿›è¡Œè®¤è¯ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨[auth0-react SDK](https://github.com/auth0/auth0-react)ç”¨äºReactå•é¡µåº”ç”¨(SPA)ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`AppAuth0.tsx`å®¹å™¨æ¥æ¸²æŸ“æˆ‘ä»¬çš„åº”ç”¨ï¼Œå› ä¸ºå®ƒå·²é€šè¿‡[Auth0](https://auth0.com)è®¤è¯ã€‚è¯¥ç»„ä»¶ä¸`App.tsx`ç»„ä»¶ç›¸åŒï¼Œä½†ä½¿ç”¨äº†`useAuth0` React Hookï¼Œç§»é™¤äº†æ³¨å†Œå’Œç™»å½•è·¯ç”±çš„éœ€æ±‚ï¼Œå¹¶ç”¨`withAuthenticationRequired`é«˜é˜¶å‡½æ•°(HOC)åŒ…è£…äº†ç»„ä»¶ã€‚

æ·»åŠ äº†ä¸€ä¸ª`useEffect`é’©å­æ¥è·å–è®¤è¯ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œï¼Œå¹¶å‘é€ä¸€ä¸ªå¸¦æœ‰`user`å’Œ`token`å¯¹è±¡çš„`AUTH0`äº‹ä»¶ï¼Œä»¥ä¸ç°æœ‰çš„è®¤è¯å±‚(`authMachine.ts`)ä¸€èµ·å·¥ä½œã€‚

```jsx title='containers/AppAuth0.tsx'
// åˆå§‹å¯¼å…¥...

import { withAuthenticationRequired, useAuth0 } from '@auth0/auth0-react'

// ...

const AppAuth0 = () => {
  const { isAuthenticated, user, getAccessTokenSilently } = useAuth0()

  // ...

  useEffect(() => {
    ;(async function waitForToken() {
      const token = await getAccessTokenSilently()
      authService.send('AUTH0', { user, token })
    })()
  }, [user, getAccessTokenSilently])

  // ...

  const isLoggedIn =
    isAuthenticated &&
    (authState.matches('authorized') ||
      authState.matches('refreshing') ||
      authState.matches('updating'))

  return <div className={classes.root}>// ...</div>
}

export default withAuthenticationRequired(AppAuth0)
```

æ³¨æ„ï¼šå®Œæ•´çš„[AppAuth0.tsxç»„ä»¶](https://github.com/cypress-io/cypress-realworld-app/blob/develop/src/containers/AppAuth0.tsx)åœ¨<Icon name="github" inline="true" contentType="rwa" />ä¸­ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ›´æ–°å…¥å£ç‚¹(`index.tsx`)ï¼Œç”¨[auth0-react SDK](https://github.com/auth0/auth0-react)çš„`<Auth0Provider>`åŒ…è£…æˆ‘ä»¬çš„åº”ç”¨ï¼Œæä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„`onRedirectCallback`ã€‚æˆ‘ä»¬ä¼ é€’ä¸Šé¢`.env`ä¸­è®¾ç½®çš„Auth0ç¯å¢ƒå˜é‡çš„propsï¼Œå¹¶æ¸²æŸ“æˆ‘ä»¬çš„`<AppAuth0>`ç»„ä»¶ä½œä¸ºåº”ç”¨ã€‚

```jsx title='index.tsx'
// åˆå§‹å¯¼å…¥...

import AppAuth0 from "./containers/AppAuth0";

// ..

const onRedirectCallback = (appState: any) => {
  history.replace((appState && appState.returnTo) || window.location.pathname);
};

if (process.env.REACT_APP_AUTH0) {
  ReactDOM.render(
    <Auth0Provider
      domain={process.env.REACT_APP_AUTH0_DOMAIN!}
      clientId={process.env.REACT_APP_AUTH0_CLIENTID!}
      redirectUri={window.location.origin}
      audience={process.env.REACT_APP_AUTH0_AUDIENCE}
      scope={process.env.REACT_APP_AUTH0_SCOPE}
      onRedirectCallback={onRedirectCallback}
    >
      <Router history={history}>
        <ThemeProvider theme={theme}>
          <AppAuth0 />
        </ThemeProvider>
      </Router>
    </Auth0Provider>,
    document.getElementById("root")
  );
} else {
  // æ¸²æŸ“passport-local App.tsx
}
```

éœ€è¦æ›´æ–°æˆ‘ä»¬çš„[AppAuth0.tsxç»„ä»¶](https://github.com/cypress-io/cypress-realworld-app/blob/develop/src/containers/AppAuth0.tsx)ä»¥æœ‰æ¡ä»¶åœ°ä½¿ç”¨`auth0Cypress` `localStorage`é¡¹ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åŸºäºåœ¨Cypressä¸‹æµ‹è¯•ï¼ˆä½¿ç”¨`window.Cypress`ï¼‰æœ‰æ¡ä»¶åœ°åº”ç”¨`useEffect`å—ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬å°†æ›´æ–°å¯¼å‡ºï¼Œå¦‚æœä¸åœ¨Cypressæµ‹è¯•ä¸­ï¼Œåˆ™ç”¨`withAuthenticationRequired`åŒ…è£…ã€‚è¿™å…è®¸æˆ‘ä»¬çš„åº”ç”¨åœ¨å¼€å‘/ç”Ÿäº§ä¸­ä½¿ç”¨[Auth0](https://auth0.com)é‡å®šå‘ç™»å½•æµç¨‹ï¼Œä½†åœ¨Cypressæµ‹è¯•ä¸­ä¸ä½¿ç”¨ã€‚

```jsx title='containers/AppAuth0.tsx'
// åˆå§‹å¯¼å…¥...

import { withAuthenticationRequired, useAuth0 } from "@auth0/auth0-react";

// ...

const AppAuth0 = () => {
  const { isAuthenticated, user, getAccessTokenSilently } = useAuth0();

  // ...

  useEffect(() => {
      (async function waitForToken() {
        const token = await getAccessTokenSilently();
        authService.send("AUTH0", { user, token });
      })();
    }, [user, getAccessTokenSilently]);

  // å¦‚æœåœ¨Cypressæµ‹è¯•ä¸­ï¼Œä»"auth0Cypress" localstorageè·å–å‡­è¯
  // å¹¶å‘æˆ‘ä»¬çš„çŠ¶æ€ç®¡ç†å‘é€äº‹ä»¶ä»¥å°†ç”¨æˆ·ç™»å½•åˆ°SPA
  if (window.Cypress) {
    useEffect(() => {
      const auth0 = JSON.parse(localStorage.getItem("auth0Cypress")!);
      authService.send("AUTH0", {
        user: auth0.body.decodedToken.user,
        token: auth0.body.access_token,
      });
    }, []);
  } else {
    useEffect(() => {
      (async function waitForToken() {
        const token = await getAccessTokenSilently();
        authService.send("AUTH0", { user, token });
      })();
    }, [isAuthenticated, user, getAccessTokenSilently]);
  }

  // ...

  const isLoggedIn =
    isAuthenticated &&
    (authState.matches("authorized") ||
      authState.matches("refreshing") ||
      authState.matches("updating"));

  return (
    <div className={classes.root}>
      // ...
    </div>
  );
};

// å¦‚æœä¸åœ¨Cypressæµ‹è¯•ä¸­ï¼Œåˆ™æœ‰æ¡ä»¶å¯¼å‡ºç”¨`withAuthenticationRequired`åŒ…è£…
let appAuth0 = window.Cypress ? AppAuth0 : withAuthenticationRequired(AppAuth0);
export default appAuth0
```

## Auth0ç™»å½•é€Ÿç‡é™åˆ¶

æ³¨æ„[Auth0æ–‡æ¡£](https://auth0.com/docs/connections/database/rate-limits)ä¸­çš„é€Ÿç‡é™åˆ¶ -

éšç€æµ‹è¯•å¥—ä»¶è§„æ¨¡çš„å¢å¤§ä»¥åŠå¯ç”¨[å¹¶è¡Œè¿è¡Œ](/cloud/features/smart-orchestration/parallelization)ä»¥åŠ å¿«æµ‹è¯•è¿è¡Œæ—¶é—´ï¼Œå¯èƒ½ä¼šè¾¾åˆ°æ­¤é™åˆ¶ã€‚

å¦‚æœé‡åˆ°æ­¤é€Ÿç‡é™åˆ¶ï¼Œå¯ä»¥åœ¨æµ‹è¯•è¿è¡Œå‰å‘`loginByAuth0`å‘½ä»¤æ·»åŠ ç¼–ç¨‹å¼æ–¹æ³•æ¥æ¸…é™¤è¢«é˜»æ­¢çš„IPã€‚

ä½ éœ€è¦è·å–ä¸€ä¸ª[APIä»¤ç‰Œ](https://auth0.com/docs/api/management/v2/tokens)æ¥ä¸[Auth0ç®¡ç†API](https://auth0.com/docs/api/management/v2)äº¤äº’ã€‚æ­¤ä»¤ç‰Œæ˜¯ä¸€ä¸ªJSON Webä»¤ç‰Œ(JWT)ï¼Œå®ƒåŒ…å«APIçš„ç‰¹å®šæˆäºˆæƒé™ã€‚

å°†æ­¤ä»¤ç‰Œä½œä¸ºç¯å¢ƒå˜é‡`AUTH0_MGMT_API_TOKEN`æ·»åŠ åˆ°æˆ‘ä»¬çš„<Icon name="github" inline="true" contentType="rwa" /> `.env`æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ä½ çš„APIä»¤ç‰Œã€‚

```jsx title='.env'
// ... å…¶ä»–é”®
AUTH0_MGMT_API_TOKEN = 'ä½ çš„ç®¡ç†APIä»¤ç‰Œ'
```

æœ‰äº†è¿™ä¸ªä»¤ç‰Œï¼Œæˆ‘ä»¬å¯ä»¥å‘[Auth0å¼‚å¸¸åˆ é™¤è¢«é˜»æ­¢IPåœ°å€ç«¯ç‚¹](https://auth0.com/docs/api/management/v2#!/Anomaly/delete_ips_by_id)æ·»åŠ äº¤äº’åˆ°æˆ‘ä»¬çš„`loginByAuth0Api`å‘½ä»¤ã€‚è¿™å°†å‘[Auth0ç®¡ç†API](https://auth0.com/docs/api/management/v2)å¼‚å¸¸ç«¯ç‚¹å‘é€åˆ é™¤è¯·æ±‚ï¼Œä»¥è§£é™¤å¯èƒ½åœ¨æµ‹è¯•è¿è¡ŒæœŸé—´è¢«é˜»æ­¢çš„IPã€‚

:::info

[icanhazip.com](http://icanhazip.com/)æ˜¯ä¸€ä¸ªå…è´¹çš„æ‰˜ç®¡æœåŠ¡ï¼Œç”¨äºæŸ¥æ‰¾ç³»ç»Ÿçš„å½“å‰å¤–éƒ¨IPåœ°å€ã€‚

:::

```jsx title='cypress/support/commands.js'
Cypress.Commands.add('loginByAuth0Api', (username, password) => {
  // å½“è¢«Auth0é€Ÿç‡é™åˆ¶æ—¶æœ‰ç”¨
  cy.exec('curl -4 icanhazip.com')
    .its('stdout')
    .then((ip) => {
      cy.request({
        method: 'DELETE',
        url: `https://${Cypress.env(
          'auth0_domain'
        )}/api/v2/anomaly/blocks/ips/${ip}`,
        auth: {
          bearer: Cypress.env('auth0_mgmt_api_token'),
        },
      })
    })

  // ... loginByAuth0Apiå‘½ä»¤çš„å‰©ä½™éƒ¨åˆ†
})
```