---
title: 'Azure Active Directory è®¤è¯ï¼šCypress æŒ‡å—'
sidebar_label: Azure Active Directory è®¤è¯
description: å­¦ä¹ å¦‚ä½•é…ç½® Cypress æ¥æµ‹è¯• Azure Active Directory ç½‘é¡µåº”ç”¨ï¼Œå¹¶ä½¿ç”¨ `cy.origin()` è¿›è¡Œ Azure Active Directory è®¤è¯ã€‚
---

<ProductHeading product="app" />

# Azure Active Directory è®¤è¯

:::info

##### <Icon name="question-circle" color="#4BBFD2" /> ä½ å°†å­¦åˆ°

- å¦‚ä½•é…ç½® Cypress æ¥æµ‹è¯• Azure Active Directory ç½‘é¡µåº”ç”¨
- å¦‚ä½•ä½¿ç”¨ `cy.origin()` è¿›è¡Œ Azure Active Directory è®¤è¯

:::

æœ¬æŒ‡å—é€‚ç”¨äºæµ‹è¯•ä½¿ç”¨ [Azure Active Directory](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis) (AAD) è¿›è¡Œç”¨æˆ·è®¤è¯çš„å•é¡µåº”ç”¨ (SPA)ã€‚åœ¨æœ¬æŒ‡å—ä¸­ï¼Œç½‘é¡µåº”ç”¨ä½¿ç”¨ Microsoft è®¤è¯åº“ [`@azure/msal-browser`](https://www.npmjs.com/package/@azure/msal-browser) åŒ…æ¥ä»£ç†æ­¤è®¤è¯ã€‚

æœ¬æŒ‡å—ä¹Ÿå¯ä½œä¸ºä½¿ç”¨ Cypress æµ‹è¯•å…¶ä»–ä½¿ç”¨ Azure Active Directory æœåŠ¡çš„ç½‘é¡µåº”ç”¨çš„åŸºç¡€ï¼Œä¾‹å¦‚ä½¿ç”¨ Reactã€Angular æˆ– Vue æ¡†æ¶çš„åº”ç”¨ã€‚

## Microsoft AAD åº”ç”¨è®¾ç½®

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¦‚ä½•é…ç½® Cypress æ¥æµ‹è¯• Azure Active Directory ç½‘é¡µåº”ç”¨ã€‚è¯·å…‹éš† [Microsoft Identity JavaScript Tutorial](https://github.com/Azure-Samples/ms-identity-javascript-tutorial/tree/c1956b658efa331bb5df11a0038ad32d12dad3ce/1-Authentication/1-sign-in) å¹¶æŒ‰ç…§æ­¥éª¤è®¾ç½®ä½ çš„åº”ç”¨ã€‚

è®¾ç½®å®Œæˆåï¼Œä½ éœ€è¦åœ¨ `App/index.html` æ–‡ä»¶ä¸­è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼š

- ç§»é™¤ `<script>` æ ‡ç­¾ä¸­çš„æ‰€æœ‰ [`integrity`](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity) å±æ€§ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ä»»ä½• SRI å±æ€§ä¸åŒ¹é…ï¼Œå› ä¸º Cypress å¿…é¡»é‡å†™ä»»ä½• [æ¡†æ¶ç ´åä»£ç ](/app/references/configuration#modifyObstructiveCode)ã€‚è¿™ä»…åœ¨æµ‹è¯•åº”ç”¨æ—¶æ¨èã€‚
- å–æ¶ˆæ³¨é‡Š `authRedirect.js` çš„ `<script>` æ ‡ç­¾å¹¶æ³¨é‡Šæ‰ `authPopup.js` çš„ `<script>` æ ‡ç­¾ã€‚è®¤è¯ [å¼¹çª—](/app/references/trade-offs#Permanent-trade-offs) åœ¨ Cypress ä¸­æ— æ³•å·¥ä½œã€‚

åœ¨ `server.js` ä¸­ï¼Œä½ ä¼šçœ‹åˆ°å¯¹ `express-rate-limit` çš„å¼•ç”¨ï¼Œå®ƒé™åˆ¶æ¯ä¸ªçª—å£åœ¨ 15 åˆ†é’Ÿå†…æœ€å¤š 100 ä¸ªè¯·æ±‚ã€‚åœ¨æµ‹è¯•ä¸­ï¼Œä½ çš„åº”ç”¨å¯èƒ½ä¼šè¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œå› ä¸ºä½ å°†é‡æ–°åŠ è½½åº”ç”¨å¹¶å‘ä»£ç†/éªŒè¯è®¤è¯å‘èµ·è¯·æ±‚ã€‚å¯¹äºæœ¬æ¼”ç¤ºï¼Œä½ å¯ä»¥ï¼š

- ç§»é™¤é€Ÿç‡é™åˆ¶ä»£ç ï¼ˆä»…æ¨èç”¨äºæ¼”ç¤ºç›®çš„ï¼‰ã€‚
- å®æ–½ä¸€ä¸ªç­–ç•¥æ¥å¢åŠ æµ‹è¯•æ—¶çš„é€Ÿç‡é™åˆ¶ã€‚

å®Œæˆåï¼Œä½ çš„ SPA åº”è¯¥è¿è¡Œåœ¨ `http://localhost:3000` ä¸Šï¼Œå¹¶æ­£ç¡®é…ç½®ä¸ºä¸ Azure Active Directory å’Œ Cypress ä¸€èµ·è¿è¡Œã€‚

## é…ç½® Cypress ä½¿ç”¨ Microsoft AAD

ä¸ºäº†åœ¨æµ‹è¯•ä¸­è®¿é—®æµ‹è¯•ç”¨æˆ·å‡­æ®ï¼Œæˆ‘ä»¬éœ€è¦é…ç½® Cypress ä½¿ç”¨ [Azure Active Directory](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis) ç”¨æˆ·å‡­æ®ï¼Œè¿™äº›å‡­æ®åº”è®¾ç½®åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `cypress.env.json` æ–‡ä»¶ä¸­ã€‚

```json title="cypress.env.json"
{
  "aad_username": "AAD_USERNAME",
  "aad_password": "AAD_PASSWORD",
  "aad_name": "AAD_NAME"
}
```

æ­¤å¤–ï¼Œä¸ºäº†ä¸ Azure Active Directory è¿›è¡Œè®¤è¯ï¼Œä½ éœ€è¦åœ¨ e2e é…ç½®ä¸­å¯ç”¨ [`experimentalModifyObstructiveThirdPartyCode`](/app/guides/cross-origin-testing#Modifying-Obstructive-Third-Party-Code) é…ç½®é€‰é¡¹ã€‚å¦‚æœä¸å¯ç”¨ï¼Œä½ çš„è®¤è¯æµç¨‹å°†è¿›å…¥æ— é™é‡å®šå‘å¾ªç¯ã€‚

:::cypress-config-example

```js
{
  e2e: {
    experimentalModifyObstructiveThirdPartyCode: true
  }
}
```

:::

## ä½¿ç”¨ [`cy.origin()`](/api/commands/origin) ç™»å½•

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªåä¸º `loginToAAD` çš„è‡ªå®šä¹‰å‘½ä»¤æ¥æ‰§è¡Œ [Azure Active Directory](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis) ç™»å½•ã€‚æ­¤å‘½ä»¤å°†ä½¿ç”¨ [`cy.origin()`](/api/commands/origin) æ¥ï¼š

1. å¯¼èˆªåˆ° `login.microsoftonline.com` ä¸Šçš„ Azure Active Directory ç™»å½•é¡µé¢
2. è¾“å…¥ç”¨æˆ·å‡­æ®
3. ç™»å½•å¹¶é‡å®šå‘å›æ¼”ç¤ºåº”ç”¨
4. ä½¿ç”¨ [`cy.session()`](/api/commands/session) ç¼“å­˜ç»“æœ

```js title="cypress/support/commands.ts"
function loginViaAAD(username: string, password: string) {
  cy.visit('http://localhost:3000/')
  cy.get('button#signIn').click()

  // ç™»å½•åˆ°ä½ çš„ AAD ç§Ÿæˆ·ã€‚
  cy.origin(
    'login.microsoftonline.com',
    {
      args: {
        username,
      },
    },
    ({ username }) => {
      cy.get('input[type="email"]').type(username, {
        log: false,
      })
      cy.get('input[type="submit"]').click()
    }
  )

  // æ ¹æ®ç”¨æˆ·åŠå…¶åœ¨ Microsoft çš„æ³¨å†Œæ–¹å¼ï¼Œæ¥æºå¯èƒ½ä¼šè½¬åˆ° live.com
  cy.origin(
    'login.live.com',
    {
      args: {
        password,
      },
    },
    ({ password }) => {
      cy.get('input[type="password"]').type(password, {
        log: false,
      })
      cy.get('input[type="submit"]').click()
      cy.get('#idBtn_Back').click()
    }
  )

  // ç¡®ä¿ Microsoft å·²å°†æˆ‘ä»¬é‡å®šå‘å›ç¤ºä¾‹åº”ç”¨ï¼Œå¹¶å·²ç™»å½•ç”¨æˆ·ã€‚
  cy.url().should('equal', 'http://localhost:3000/')
  cy.get('#welcome-div').should(
    'contain',
    `Welcome ${Cypress.env('aad_username')}!`
  )
}

Cypress.Commands.add('loginToAAD', (username: string, password: string) => {
  const log = Cypress.log({
    displayName: 'Azure Active Directory Login',
    message: [`ğŸ” Authenticating | ${username}`],
    autoEnd: false,
  })
  log.snapshot('before')

  loginViaAAD(username, password)

  log.snapshot('after')
  log.end()
})
```

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ `loginToAAD` å‘½ä»¤ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬é€šè¿‡ Azure Active Directory ç™»å½•ç”¨æˆ·å¹¶è¿è¡ŒåŸºæœ¬å¥å…¨æ€§æ£€æŸ¥çš„æµ‹è¯•ã€‚

```js title="auth.cy.js"
describe('Azure Active Directory Authentication', () => {
  beforeEach(() => {
    // ä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰å‘½ä»¤é€šè¿‡ç¤ºä¾‹ SPA ç™»å½•åˆ° Azure Active Directory
    cy.loginToAAD(Cypress.env('aad_username'), Cypress.env('aad_password'))
    cy.visit('http://localhost:3000')
  })

  it('verifies the user logged in has the correct name', () => {
    cy.get('#table-body-div td:contains("name") + td').should(
      'contain',
      `${Cypress.env('aad_name')}`
    )
  })

  it('verifies the user logged in has the correct preferred name', () => {
    cy.get('#table-body-div td:contains("preferred_username") + td').should(
      'contain',
      `${Cypress.env('aad_username')}`
    )
  })
})
```

<DocsVideo
  src="https://vimeo.com/789095126"
  title="Azure Active Directory authentication with cy.origin()"
/>

æˆ‘ä»¬ç°åœ¨æœ‰äº†å¯ç”¨çš„è®¤è¯å’Œæµ‹è¯•ï¼ä½†æˆ‘ä»¬åœ¨æ¯ä¸ªæµ‹è¯•å‰éƒ½è¿›è¡Œç™»å½•ï¼Œè¿™ä¸ä»…è€—æ—¶ï¼Œè¿˜å¯èƒ½å¯¼è‡´ç”±äºè¯·æ±‚æ•°é‡è¿‡å¤šè€Œè§¦å‘ API é€Ÿç‡é™åˆ¶ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ„æˆ‘ä»¬çš„ç™»å½•å‘½ä»¤ï¼Œåˆ©ç”¨ [`cy.session()`](/api/commands/session) æ¥å­˜å‚¨æˆ‘ä»¬ç™»å½•ç”¨æˆ·çš„ä»¤ç‰Œå’Œ/æˆ– cookieï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…åœ¨æ¯ä¸ªæµ‹è¯•å‰é‡æ–°è®¤è¯ã€‚

```ts title="cypress/support/commands.ts"
Cypress.Commands.add('loginToAAD', (username: string, password: string) => {
  cy.session(
    `aad-${username}`,
    () => {
      const log = Cypress.log({
        displayName: 'Azure Active Directory Login',
        message: [`ğŸ” Authenticating | ${username}`],
        // @ts-ignore
        autoEnd: false,
      })

      log.snapshot('before')

      loginViaAAD(username, password)

      log.snapshot('after')
      log.end()
    },
    {
      validate: () => {
        // è¿™æ˜¯æœ¬æ¼”ç¤ºä¸­éå¸¸åŸºæœ¬çš„ä¼šè¯éªŒè¯å½¢å¼ã€‚
        // æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œå¯èƒ½éœ€è¦æ›´è¯¦ç»†çš„éªŒè¯
        cy.visit('http://localhost:3000')
        cy.get('#welcome-div').should(
          'contain',
          `Welcome ${Cypress.env('aad_username')}!`
        )
      },
    }
  )
})
```

<DocsVideo
  src="https://vimeo.com/789095038"
  title="Azure Active Directory authentication with cy.session()"
/>

é€šè¿‡ä½¿ç”¨ [`cy.session()`](/api/commands/session)ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç°åœ¨åº”è¯¥è¿è¡Œå¾—æ›´å¿«ï¼

æˆ‘ä»¬å¸Œæœ›æœ¬æŒ‡å—èƒ½å¸®åŠ©ä½ å¼€å§‹ä½¿ç”¨ [`cy.origin()`](/api/commands/origin) å’Œ [`cy.session()`](/api/commands/session)ã€‚å¦‚æœä½ åœ¨éµå¾ªæœ¬æŒ‡å—æ—¶é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œæˆ–æœ‰ä»»ä½•åé¦ˆï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬å¹¶æäº¤ [Github issue](https://github.com/cypress-io/cypress-documentation/issues/new/choose)ã€‚ç¥ä½ æµ‹è¯•æ„‰å¿«ï¼

## å¦è¯·å‚é˜…

- [è·¨æºæµ‹è¯•æŒ‡å—](/app/guides/cross-origin-testing)
- [AWS Cognito è®¤è¯æŒ‡å—](/app/guides/authentication-testing/amazon-cognito-authentication)
- [Okta è®¤è¯æŒ‡å—](/app/guides/authentication-testing/okta-authentication)
- [`cy.origin()`](/api/commands/origin)
- [`cy.session()`](/api/commands/session)