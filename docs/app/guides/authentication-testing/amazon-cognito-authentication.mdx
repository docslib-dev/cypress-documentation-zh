---
title: 'Amazon Cognito èº«ä»½éªŒè¯ï¼šCypress æŒ‡å—'
sidebar_label: 'Amazon Cognito èº«ä»½éªŒè¯'
description: 'åœ¨ Cypress ä¸­å®ç° Amazon Cognito èº«ä»½éªŒè¯ã€‚å®‰å…¨ç®¡ç† Cypress ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯ä¸­çš„èº«ä»½éªŒè¯æµç¨‹'
---

<ProductHeading product="app" />

# Amazon Cognito èº«ä»½éªŒè¯

:::info

##### <Icon name="question-circle" color="#4BBFD2" /> æ‚¨å°†å­¦ä¹ åˆ°

- å¦‚ä½•åœ¨ Cypress ä¸­å®ç° Amazon Cognito èº«ä»½éªŒè¯
- å¦‚ä½•å®‰å…¨ç®¡ç† Cypress ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯ä¸­çš„èº«ä»½éªŒè¯æµç¨‹

:::

Amazon [Cognito](https://aws.amazon.com/cognito) æ˜¯ [Amazon Web Services (AWS)](https://aws.amazon.com) æä¾›çš„èº«ä»½éªŒè¯æœåŠ¡ã€‚

[Amazon Cognito](https://aws.amazon.com/cognito) æ–‡æ¡£æ¨èä½¿ç”¨ [AWS Amplify æ¡†æ¶èº«ä»½éªŒè¯åº“](https://aws-amplify.github.io/amplify-js/api/classes/authclass.html) æ¥ä¸å·²éƒ¨ç½²çš„ [Amazon Cognito](https://aws.amazon.com/cognito) å®ä¾‹äº¤äº’ã€‚é€šè¿‡è¯¥åº“ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–ç¨‹æ–¹å¼é©±åŠ¨ç”¨æˆ·çš„åˆ›å»ºå’Œèº«ä»½éªŒè¯æµç¨‹ã€‚

æœ¬æŒ‡å—å±•ç¤ºäº†ä½¿ç”¨ [AWS Amplify æ¡†æ¶](https://aws.amazon.com/amplify/framework/) æ‰€éœ€çš„æœ€ç®€ä»£ç ï¼Œä»¥ç¼–ç¨‹æ–¹å¼ç™»å½•ç°æœ‰ç”¨æˆ·ã€‚

<Tabs>

  <TabItem value="v5" label="Amplify v5.x.x" default>

```jsx
// å¼•å…¥ 'aws-amplify' åº“
import Amplify, { Auth } from 'aws-amplify'

// ä½¿ç”¨ Amazon Cognito å‡­è¯é…ç½® Auth æ¨¡å—
Amplify.configure({
  Auth: {
    identityPoolId: 'XX-XXXX-X:XXXXXXXX-XXXX', // Amazon Cognito èº«ä»½æ±  ID
    region: 'XX-XXXX-X', // Amazon Cognito åŒºåŸŸ
  },
})

// è°ƒç”¨ Auth.signIn ä¼ å…¥ç”¨æˆ·å‡­è¯
Auth.signIn(username, password)
  .then((user) => console.log(user))
  .catch((err) => console.log(err))
```

  </TabItem>

  <TabItem value="v6" label="Amplify v6.x.x">

```tsx
import { Amplify } from "aws-amplify";
import { fetchAuthSession, signIn } from "aws-amplify/auth";

Amplify.configure({
  Auth: {
    Cognito: {
      userPoolId: "XX-XXXX-X_XXXXXXXXX",
      userPoolClientId: "XXXXXXXXXXXXXXXXXXXXXXXXX",
      // æˆ–:
      identityPoolId: 'XX-XXXX-X:XXXXXXXX-XXXX', // Amazon Cognito èº«ä»½æ±  ID
    },
  },
});
signIn({ username, password, { authFlowType: "USER_PASSWORD_AUTH" } })
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  .then((_signInOutput) => fetchAuthSession())
  .then((authSession) => console.log(authSession))
  .catch((err) => console.log(err));
```

  </TabItem>

</Tabs>

## Amazon Cognito è®¾ç½®

å¦‚æœå°šæœªè®¾ç½®ï¼Œæ‚¨éœ€è¦å…ˆ[åˆ›å»º AWS è´¦æˆ·](https://docs.amplify.aws/start/getting-started/installation/q/integration/react#sign-up-for-an-aws-account)ã€‚

<Icon name="github" inline="true" contentType="rwa" /> ä¸­æä¾›äº† [Amazon Cognito](https://aws.amazon.com/cognito) é›†æˆã€‚å…‹éš† Cypress Real World App å¹¶å®‰è£… [AWS Amplify CLI](https://docs.amplify.aws/cli)ï¼š

```jsx
npm install @aws-amplify/cli --global
```

<Icon name="github" inline="true" contentType="rwa" /> é€šè¿‡ [AWS Amplify èº«ä»½éªŒè¯åº“](https://aws-amplify.github.io/amplify-js/api/classes/authclass.html) é…ç½®äº†å¯é€‰çš„ [Amazon Cognito](https://aws.amazon.com/cognito) å®ä¾‹ã€‚[AWS Amplify CLI](https://docs.amplify.aws/cli) ç”¨äºé…ç½®æ‚¨çš„ç¯å¢ƒå’Œäº‘èµ„æºæ‰€éœ€çš„åŸºç¡€è®¾æ–½ã€‚

é¦–å…ˆè¿è¡Œ [amplify init](https://docs.amplify.aws/cli/start/workflows#initialize-new-project) å‘½ä»¤åˆå§‹åŒ–é¡¹ç›®ï¼š

```jsx
amplify init
```

ç„¶åè¿è¡Œ [amplify push](https://docs.amplify.aws/cli/start/workflows#amplify-push) å‘½ä»¤åœ¨äº‘ç«¯åˆ›å»ºèµ„æºï¼š

```jsx
amplify push
```

:::info

<strong>æ³¨æ„</strong>

å¯åŠ¨ Real World App æ—¶ä½¿ç”¨ `yarn dev:cognito` å‘½ä»¤ã€‚

:::

## åœ¨ Cypress ä¸­è®¾ç½® Amazon Cognito åº”ç”¨å‡­è¯

é¦–å…ˆé…ç½® Cypress ä½¿ç”¨ `.env` æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡å’Œ [AWS Amplify CLI](https://docs.amplify.aws/cli) æ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„ `aws-exports.js` æ–‡ä»¶ã€‚

:::cypress-config-example

```ts
// ä» .env æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
require('dotenv').config()
// AWS å¯¼å‡ºé…ç½®
const awsConfig = require('./aws-exports-es5.js')
```

```js
{
  env: {
    cognito_username: process.env.AWS_COGNITO_USERNAME,
    cognito_password: process.env.AWS_COGNITO_PASSWORD,
    awsConfig: awsConfig.default
  }
}
```

:::

## Amazon Cognito èº«ä»½éªŒè¯è‡ªå®šä¹‰å‘½ä»¤

æœ‰ä¸¤ç§èº«ä»½éªŒè¯æ–¹å¼ï¼š

- [ä½¿ç”¨ `cy.origin()` ç™»å½•](/app/guides/authentication-testing/amazon-cognito-authentication#Login-with-cyorigin)
- [ç¼–ç¨‹å¼è®¿é—®](/app/guides/authentication-testing/amazon-cognito-authentication#Programmatic-Login)

### ä½¿ç”¨ [`cy.origin()`](/api/commands/origin) ç™»å½•

åˆ›å»º `loginByCognito` è‡ªå®šä¹‰å‘½ä»¤æ¥æ‰§è¡Œç™»å½•æµç¨‹ï¼š

```jsx title="cypress/support/auth-provider-commands/cognito.ts"
// Amazon Cognito
const loginToCognito = (username: string, password: string) => {
  Cypress.log({
    displayName: 'COGNITO LOGIN',
    message: [`ğŸ” Authenticating | ${username}`],
    autoEnd: false,
  })

  cy.visit('/')

  cy.origin(
    Cypress.env('cognito_domain'),
    {
      args: {
        username,
        password,
      },
    },
    ({ username, password }) => {
      cy.contains('Sign in with your email and password')
      cy.get('input[name="username"]:visible').type(username)
      cy.get('input[name="password"]:visible').type(password, {
        log: false,
      })
      cy.get('input[name="signInSubmitButton"]:visible').click()
    }
  )

  cy.wait(2000)
  cy.contains('Get Started').should('be.visible')
}

Cypress.Commands.add('loginByCognito', (username, password) => {
  return loginToCognito(username, password)
})
```

æµ‹è¯•ä¸­ä½¿ç”¨è¯¥å‘½ä»¤ï¼š

```jsx title="auth.spec.js"
describe('Cognito, cy.origin() login', function () {
  beforeEach(function () {
    cy.task('db:seed')
    cy.loginByCognito(
      Cypress.env('cognito_username'),
      Cypress.env('cognito_password')
    )
  })

  it('shows onboarding', function () {
    cy.contains('Get Started').should('be.visible')
  })
})
```

<DocsVideo
  src="https://vimeo.com/789093851"
  title="ä½¿ç”¨ cy.origin() è¿›è¡Œ AWS Cognito èº«ä»½éªŒè¯"
/>

ä½¿ç”¨ [`cy.session()`](/api/commands/session) ä¼˜åŒ–ç™»å½•å‘½ä»¤ï¼š

```jsx title="cypress/support/auth-provider-commands/cognito.ts"
Cypress.Commands.add(
  'loginByCognito, cy.origin() login',
  (username, password) => {
    cy.session(
      `cognito-${username}`,
      () => {
        return loginToCognito(username, password)
      },
      {
        validate() {
          cy.visit('/')
          cy.contains('Get Started').should('be.visible')
        },
      }
    )
  }
)
```

<DocsVideo
  src="https://vimeo.com/789093817"
  title="ä½¿ç”¨ cy.session() è¿›è¡Œ AWS Cognito èº«ä»½éªŒè¯"
/>

### ç¼–ç¨‹å¼ç™»å½•

åˆ›å»º `loginByCognitoApi` å‘½ä»¤é€šè¿‡ API ç™»å½•å¹¶è®¾ç½® localStorageï¼š

<Tabs>

  <TabItem value="v5" label="Amplify v5.x.x" default>

```jsx title="cypress/support/auth-provider-commands/cognito.ts"
import Amplify, { Auth } from 'aws-amplify'

Amplify.configure(Cypress.env('awsConfig'))

Cypress.Commands.add('loginByCognitoApi', (username, password) => {
  const log = Cypress.log({
    displayName: 'COGNITO LOGIN',
    message: [`ğŸ” Authenticating | ${username}`],
    autoEnd: false,
  })

  log.snapshot('before')

  const signIn = Auth.signIn({ username, password })

  cy.wrap(signIn, { log: false }).then((cognitoResponse) => {
    const keyPrefixWithUsername = `${cognitoResponse.keyPrefix}.${cognitoResponse.username}`

    window.localStorage.setItem(
      `${keyPrefixWithUsername}.idToken`,
      cognitoResponse.signInUserSession.idToken.jwtToken
    )

    // è®¾ç½®å…¶ä»– token...
  })

  cy.visit('/')
})
```

  </TabItem>

  <TabItem value="v6" label="Amplify v6.x.x">

```tsx title="cypress/support/auth-provider-commands/cognito.ts"
import { Amplify } from 'aws-amplify'
import { fetchAuthSession, signIn } from 'aws-amplify/auth'

Amplify.configure(Cypress.env('awsConfig'))
const fetchJwts = async (username: string, password: string) => {
  const options = { authFlowType: 'USER_PASSWORD_AUTH' as const }
  await signIn({ username, password, options })
  const authSession = await fetchAuthSession()
  const tokens = authSession.tokens!
  return {
    idToken: tokens.idToken!.toString(),
    accessToken: tokens.accessToken.toString(),
    // å…¶ä»–å­—æ®µ...
  }
}

Cypress.Commands.add(
  'loginByCognitoApi',
  (username: string, password: string) => {
    const log = Cypress.log({
      displayName: 'COGNITO LOGIN',
      message: [`ğŸ” Authenticating | ${username}`],
      autoEnd: false,
    })

    cy.wrap(fetchJwts(username, password), { log: false }).then(
      (unknownJwts) => {
        // å¤„ç† token...
      }
    )
  }
)
```

  </TabItem>

</Tabs>

æµ‹è¯•ä¸­ä½¿ç”¨ç¼–ç¨‹å¼ç™»å½•ï¼š

```jsx
describe('Cognito, programmatic login', function () {
  beforeEach(function () {
    cy.task('db:seed')
    cy.loginByCognitoApi(
      Cypress.env('cognito_username'),
      Cypress.env('cognito_password')
    )
  })

  it('shows onboarding', function () {
    cy.contains('Get Started').should('be.visible')
  })
})
```

### é€‚é… Amazon Cognito åº”ç”¨è¿›è¡Œæµ‹è¯•

:::info

<strong>AWS åç«¯æœåŠ¡æ— éœ€é€‚é…</strong>

å½“ä½¿ç”¨ AWS AppSync æˆ– API Gateway æ—¶ï¼Œå®ƒä»¬å¯ç›´æ¥éªŒè¯ Cognito JWTã€‚å¦‚æœæ˜¯è‡ªæ‰˜ç®¡åç«¯ï¼ˆå¦‚ Expressï¼‰ï¼Œåˆ™éœ€è¦é€‚é…ã€‚

:::

<Icon name="github" inline="true" contentType="rwa" /> æä¾›äº† React å‰ç«¯å’Œ Express åç«¯çš„é…ç½®å’Œä»£ç ã€‚

#### é€‚é…åç«¯

å®‰è£… [express-jwt](https://github.com/auth0/express-jwt) å’Œ [jwks-rsa](https://github.com/auth0/node-jwks-rsa) æ¥éªŒè¯ JWTï¼š

<Tabs>

  <TabItem value="v5" label="Amplify v5.x.x" default>

```jsx title="backend/helpers.ts"
import jwt from 'express-jwt'
import jwksRsa from 'jwks-rsa'

const awsCognitoJwtConfig = {
  secret: jwksRsa.expressJwtSecret({
    jwksUri: `https://cognito-idp.${awsConfig.aws_cognito_region}.amazonaws.com/${awsConfig.aws_user_pools_id}/.well-known/jwks.json`,
  }),
  issuer: `https://cognito-idp.${awsConfig.aws_cognito_region}.amazonaws.com/${awsConfig.aws_user_pools_id}`,
  algorithms: ['RS256'],
}

export const checkCognitoJwt = jwt(awsCognitoJwtConfig).unless({
  path: ['/testData/*'],
})
```

  </TabItem>

  <TabItem value="v6" label="Amplify v6.x.x">

```jsx title="backend/helpers.ts"
const userPoolId = awsConfig.Auth.Cognito.userPoolId
const region = userPoolId.split('_')[0]
const awsCognitoJwtConfig = {
  secret: jwksRsa.expressJwtSecret({
    jwksUri: `https://cognito-idp.${region}.amazonaws.com/${userPoolId}/.well-known/jwks.json`,
  }),
  issuer: `https://cognito-idp.${region}.amazonaws.com/${userPoolId}`,
  algorithms: ['RS256'],
}
```

  </TabItem>

</Tabs>

å…¨å±€åº”ç”¨ä¸­é—´ä»¶ï¼š

```jsx title="backend/app.ts"
import { checkCognitoJwt } from './helpers'

if (process.env.REACT_APP_AWS_COGNITO) {
  app.use(checkCognitoJwt)
}
```

#### é€‚é…å‰ç«¯

åˆ›å»º `AppCognito.tsx` ç»„ä»¶å¤„ç† Cognito èº«ä»½éªŒè¯ï¼š

<Tabs>
  <TabItem value="v6" label="Amplify v6.x.x">

```jsx title="src/containers/AppCognito.tsx"
import { Amplify, ResourcesConfig } from "aws-amplify";
import { fetchAuthSession, signInWithRedirect } from "aws-amplify/auth";

Amplify.configure(awsConfig as ResourcesConfig);

const AppCognito: React.FC = () => {
  useEffect(() => {
    if (!isLoggedIn) {
      fetchAuthSession().then((authSession) => {
        if (authSession?.tokens?.accessToken) {
          authService.send("COGNITO", {
            accessTokenJwtString: authSession.tokens.accessToken.toString(),
            userSub: authSession.userSub!,
            email: authSession.tokens.idToken!.payload.email,
          });
        } else {
          void signInWithRedirect();
        }
      });
    }
  }, [isLoggedIn]);

  if (!isLoggedIn) return null;
};
```

  </TabItem>

</Tabs>

æ›´æ–°å…¥å£æ–‡ä»¶ä½¿ç”¨æ–°ç»„ä»¶ï¼š

```jsx title="src/index.tsx"
if (process.env.REACT_APP_AWS_COGNITO) {
  ReactDOM.render(
    <Router history={history}>
      <ThemeProvider theme={theme}>
        <AppCognito />
      </ThemeProvider>
    </Router>,
    document.getElementById('root')
  )
}
```